<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clear IndexedDB - RMS</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #d32f2f;
            margin-top: 0;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        button {
            background: #d32f2f;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #b71c1c;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .success {
            background: #d4edda;
            border: 1px solid #28a745;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #dc3545;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #17a2b8;
            color: #0c5460;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        #status {
            margin-top: 20px;
            min-height: 50px;
        }
        .log {
            font-family: monospace;
            font-size: 12px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóëÔ∏è Clear IndexedDB - RMS</h1>
        
        <div class="warning">
            <strong>‚ö†Ô∏è WARNING:</strong> This will permanently delete all data from IndexedDB:
            <ul>
                <li>All orders</li>
                <li>All order items</li>
                <li>All sync queue entries</li>
                <li>All cart items</li>
            </ul>
            <strong>This action cannot be undone!</strong>
        </div>

        <div>
            <button id="clearBtn" onclick="clearIndexedDB()">Clear All IndexedDB Data</button>
            <button onclick="checkStatus()">Check Status</button>
            <button onclick="inspectSyncQueue()">Inspect Sync Queue</button>
            <button onclick="resetStuckSyncItems()">Reset Stuck Sync Items</button>
            <button onclick="clearSyncedItems()">Clear All SYNCED Items</button>
        </div>

        <div id="status"></div>
    </div>

    <script>
        async function clearIndexedDB() {
            const btn = document.getElementById('clearBtn');
            const statusDiv = document.getElementById('status');
            
            btn.disabled = true;
            statusDiv.innerHTML = '<div class="info">üîÑ Starting cleanup...</div>';
            
            const logs = [];
            
            try {
                // Check if IndexedDB is available
                if (!window.indexedDB) {
                    throw new Error('IndexedDB is not supported in this browser');
                }

                logs.push('1. Opening database...');
                const dbName = 'RMSDatabase';
                
                // Open without version to use current version (safest approach)
                const request = indexedDB.open(dbName);
                const db = await new Promise((resolve, reject) => {
                    request.onsuccess = () => {
                        logs.push(`   ‚úÖ Database opened (version: ${request.result.version})`);
                        resolve(request.result);
                    };
                    request.onerror = () => {
                        logs.push(`   ‚ùå Error: ${request.error?.message}`);
                        reject(request.error);
                    };
                });

                logs.push('   ‚úÖ Database opened');

                // List of stores to clear
                const storesToClear = [
                    'orders',
                    'orderItems',
                    'syncQueue',
                    'cart'
                ];

                for (const storeName of storesToClear) {
                    try {
                        logs.push(`2. Clearing ${storeName}...`);
                        const transaction = db.transaction([storeName], 'readwrite');
                        const objectStore = transaction.objectStore(storeName);
                        
                        await new Promise((resolve, reject) => {
                            const clearRequest = objectStore.clear();
                            clearRequest.onsuccess = () => {
                                logs.push(`   ‚úÖ ${storeName} cleared`);
                                resolve();
                            };
                            clearRequest.onerror = () => {
                                // Store might not exist, that's okay
                                logs.push(`   ‚ÑπÔ∏è ${storeName} does not exist or already empty`);
                                resolve();
                            };
                        });
                    } catch (error) {
                        logs.push(`   ‚ö†Ô∏è Error clearing ${storeName}: ${error.message}`);
                    }
                }

                db.close();
                logs.push('\n‚úÖ IndexedDB cleanup completed!');

                statusDiv.innerHTML = `
                    <div class="success">
                        <strong>‚úÖ Success!</strong> All IndexedDB data has been cleared.
                    </div>
                    <div class="log">${logs.join('<br>')}</div>
                `;

            } catch (error) {
                logs.push(`\n‚ùå Error: ${error.message}`);
                statusDiv.innerHTML = `
                    <div class="error">
                        <strong>‚ùå Error:</strong> ${error.message}
                    </div>
                    <div class="log">${logs.join('<br>')}</div>
                `;
            } finally {
                btn.disabled = false;
            }
        }

        async function checkStatus() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '<div class="info">üîÑ Checking IndexedDB status...</div>';
            
            try {
                if (!window.indexedDB) {
                    throw new Error('IndexedDB is not supported');
                }

                const dbName = 'RMSDatabase';
                
                // Open without version to use current version (safest approach)
                const request = indexedDB.open(dbName);
                const db = await new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                const stores = ['orders', 'orderItems', 'syncQueue', 'cart'];
                const counts = {};

                for (const storeName of stores) {
                    try {
                        const transaction = db.transaction([storeName], 'readonly');
                        const objectStore = transaction.objectStore(storeName);
                        const countRequest = objectStore.count();
                        
                        counts[storeName] = await new Promise((resolve, reject) => {
                            countRequest.onsuccess = () => resolve(countRequest.result);
                            countRequest.onerror = () => resolve(0);
                        });
                    } catch (error) {
                        counts[storeName] = 'N/A';
                    }
                }

                db.close();

                const statusHTML = `
                    <div class="info">
                        <strong>üìä IndexedDB Status:</strong><br>
                        Orders: ${counts.orders || 0}<br>
                        Order Items: ${counts.orderItems || 0}<br>
                        Sync Queue: ${counts.syncQueue || 0}<br>
                        Cart Items: ${counts.cart || 0}
                    </div>
                `;

                statusDiv.innerHTML = statusHTML;

            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="error">
                        <strong>‚ùå Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        async function inspectSyncQueue() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '<div class="info">üîÑ Inspecting sync queue...</div>';
            
            try {
                const dbName = 'RMSDatabase';
                const request = indexedDB.open(dbName);
                const db = await new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                const transaction = db.transaction(['syncQueue'], 'readonly');
                const store = transaction.objectStore('syncQueue');
                const allItems = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                const byStatus = {};
                const byTable = {};
                allItems.forEach(item => {
                    const status = item.status || 'UNKNOWN';
                    const table = item.table || 'UNKNOWN';
                    byStatus[status] = (byStatus[status] || 0) + 1;
                    byTable[table] = (byTable[table] || 0) + 1;
                });

                const stuckItems = allItems.filter(item => item.status === 'SYNCING');
                
                let html = '<div class="info">';
                html += `<strong>üìä Sync Queue Status:</strong><br>`;
                html += `Total items: ${allItems.length}<br><br>`;
                html += `<strong>By Status:</strong><br>`;
                Object.keys(byStatus).forEach(status => {
                    html += `${status}: ${byStatus[status]}<br>`;
                });
                html += `<br><strong>By Table:</strong><br>`;
                Object.keys(byTable).forEach(table => {
                    html += `${table}: ${byTable[table]}<br>`;
                });
                if (stuckItems.length > 0) {
                    html += `<br><strong>‚ö†Ô∏è Stuck Items:</strong> ${stuckItems.length} items with status SYNCING<br>`;
                    html += `These items are stuck and won't be synced. Use "Reset Stuck Sync Items" to fix them.`;
                }
                html += '</div>';

                statusDiv.innerHTML = html;

                db.close();
            } catch (error) {
                statusDiv.innerHTML = `<div class="error"><strong>‚ùå Error:</strong> ${error.message}</div>`;
            }
        }

        async function resetStuckSyncItems() {
            const confirmation = prompt('Type "RESET SYNCING" to reset all SYNCING items to PENDING:');
            if (confirmation !== 'RESET SYNCING') {
                return;
            }

            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '<div class="info">üîÑ Resetting stuck items...</div>';

            try {
                const dbName = 'RMSDatabase';
                const request = indexedDB.open(dbName);
                const db = await new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                const transaction = db.transaction(['syncQueue'], 'readwrite');
                const store = transaction.objectStore('syncQueue');
                
                // Get all items and filter for SYNCING
                const allItems = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                // Filter and update SYNCING items
                const syncingItems = allItems.filter(item => item.status === 'SYNCING');
                let count = 0;
                
                for (const item of syncingItems) {
                    await new Promise((resolve, reject) => {
                        const updateRequest = store.put({ ...item, status: 'PENDING' });
                        updateRequest.onsuccess = () => {
                            count++;
                            resolve();
                        };
                        updateRequest.onerror = () => reject(updateRequest.error);
                    });
                }

                db.close();

                statusDiv.innerHTML = `
                    <div class="success">
                        <strong>‚úÖ Success!</strong> Reset ${count} SYNCING items to PENDING status.
                        They will now be retried on the next sync.
                    </div>
                `;
            } catch (error) {
                statusDiv.innerHTML = `<div class="error"><strong>‚ùå Error:</strong> ${error.message}</div>`;
            }
        }

        async function clearSyncedItems() {
            const confirmation = prompt('Type "CLEAR SYNCED" to remove all SYNCED items from sync queue:');
            if (confirmation !== 'CLEAR SYNCED') {
                return;
            }

            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '<div class="info">üîÑ Clearing SYNCED items...</div>';

            try {
                const dbName = 'RMSDatabase';
                const request = indexedDB.open(dbName);
                const db = await new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                const transaction = db.transaction(['syncQueue'], 'readwrite');
                const store = transaction.objectStore('syncQueue');
                
                // Get all SYNCED items
                const allItems = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });

                const syncedItems = allItems.filter(item => item.status === 'SYNCED');
                let count = 0;
                
                for (const item of syncedItems) {
                    await new Promise((resolve, reject) => {
                        const deleteRequest = store.delete(item.id);
                        deleteRequest.onsuccess = () => {
                            count++;
                            resolve();
                        };
                        deleteRequest.onerror = () => reject(deleteRequest.error);
                    });
                }

                db.close();

                statusDiv.innerHTML = `
                    <div class="success">
                        <strong>‚úÖ Success!</strong> Cleared ${count} SYNCED items from sync queue.
                    </div>
                `;
            } catch (error) {
                statusDiv.innerHTML = `<div class="error"><strong>‚ùå Error:</strong> ${error.message}</div>`;
            }
        }

        // Check status on load
        window.onload = checkStatus;
    </script>
</body>
</html>

