name: Deploy RMS (Staging & Production)

on:
  push:
    branches:
      - main
      - dev
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy
    runs-on: [self-hosted, ntg-server]

    steps:
      - name: Determine Environment
        id: env
        run: |
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "ENVIRONMENT=production" >> $GITHUB_OUTPUT
            echo "DEPLOY_PATH=/home/dev/production/ntg-rms-v2" >> $GITHUB_OUTPUT
            echo "BACKEND_PORT=5001" >> $GITHUB_OUTPUT
            echo "FRONTEND_PORT=5000" >> $GITHUB_OUTPUT
            echo "BRANCH=main" >> $GITHUB_OUTPUT
          else
            echo "ENVIRONMENT=staging" >> $GITHUB_OUTPUT
            echo "DEPLOY_PATH=/home/dev/staging/ntg-rms-v2" >> $GITHUB_OUTPUT
            echo "BACKEND_PORT=8001" >> $GITHUB_OUTPUT
            echo "FRONTEND_PORT=8000" >> $GITHUB_OUTPUT
            echo "BRANCH=dev" >> $GITHUB_OUTPUT
          fi

      - name: Show Deployment Info
        run: |
          echo "üöÄ Deploying to: ${{ steps.env.outputs.ENVIRONMENT }}"
          echo "üìÅ Path: ${{ steps.env.outputs.DEPLOY_PATH }}"
          echo "üåê Frontend Port: ${{ steps.env.outputs.FRONTEND_PORT }}"
          echo "üîå Backend Port: ${{ steps.env.outputs.BACKEND_PORT }}"

      - name: Update Code on Server
        run: |
          cd ${{ steps.env.outputs.DEPLOY_PATH }}
          git fetch origin
          git reset --hard origin/${{ steps.env.outputs.BRANCH }}

      - name: Deploy
        run: |
          cd ${{ steps.env.outputs.DEPLOY_PATH }}
          
          if [ "${{ steps.env.outputs.ENVIRONMENT }}" = "production" ]; then
            echo "üè≠ Deploying PRODUCTION..."
            docker compose --env-file .env.prod down || true
            docker compose --env-file .env.prod up -d --build
          else
            echo "üß™ Deploying STAGING..."
            docker compose --env-file .env.staging -f docker-compose-staging.yml down || true
            docker compose --env-file .env.staging -f docker-compose-staging.yml up -d --build
          fi

      - name: Health Check
        run: |
          echo "‚è≥ Waiting for backend to start..."
          sleep 30
          
          MAX_RETRIES=30
          RETRY=0
          
          while [ $RETRY -lt $MAX_RETRIES ]; do
            if curl -f http://localhost:${{ steps.env.outputs.BACKEND_PORT }}/health > /dev/null 2>&1; then
              echo "‚úÖ Backend is healthy!"
              exit 0
            fi
            echo "Attempt $((RETRY+1))/$MAX_RETRIES failed, retrying..."
            sleep 5
            RETRY=$((RETRY+1))
          done
          
          echo "‚ùå Health check failed after $MAX_RETRIES attempts"
          exit 1